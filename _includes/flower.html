<!-- 结构不变 -->
<div class="flower-box">
  <button id="flower-btn" class="flower-btn" aria-label="送花">🌸 送花</button>
  <span id="flower-count" class="flower-count">0</span>
</div>

<!-- LeanCloud JS SDK（固定版本） -->
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av-min.js"></script>
<script>
  // ===== 你的 LeanCloud 初始化：保持你现在的配置 =====
  AV.init({
    appId: 'GYcDHtwby7Z0jfTPS4sE5vSB-gzGzoHsz',
    appKey: 'XHcF55G1bbSGIRgvsBeJ1htf',
    serverURL: 'https://gycdhtwb.lc-cn-n1-shared.com'
  });

  // ===== 文案（按需修改） =====
  const MSG_SUCCESS = '🌸 收到你的花啦，谢谢！愿你今天也开心。';
  const MSG_LIMITED = '今天已经送过啦，明天再来～';
  // 仅“生平第一次”才提示：true；默认：每天第一次
  const ONLY_FIRST_EVER = false;

  // ===== 基本变量 =====
  const slug = '{{ page.path }}';            // 用文件路径做 key 更稳
  const $btn = document.getElementById('flower-btn');
  const $count = document.getElementById('flower-count');

  // ===== 轻量 toast（非阻塞） =====
  function toast(msg, ms = 1800) {
    let el = document.getElementById('flower-toast');
    if (!el) {
      el = document.createElement('div');
      el.id = 'flower-toast';
      el.className = 'flower-toast';
      document.body.appendChild(el);
    }
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(el._timer);
    el._timer = setTimeout(() => el.classList.remove('show'), ms);
  }

  function showError(where, e) {
    console.error(`[Flower] ${where} error:`, e);
    const msg = `${(e && e.code) || ''} ${(e && e.message) || e}`;
    toast(`送花失败（${where}）：${msg}`);
  }

  // ===== 极简“撒花”效果（高雅、轻量、尊重减少动画） =====
  function ensurePetalLayer() {
    let layer = document.getElementById('petal-layer');
    if (!layer) {
      layer = document.createElement('div');
      layer.id = 'petal-layer';
      document.body.appendChild(layer);
    }
    return layer;
  }

  function petalsBurst(anchorEl) {
    // 系统设为“减少动画”时直接跳过
    if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

    const layer = ensurePetalLayer();
    const rect = anchorEl.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + rect.height / 2;

    const count = 14; // 数量少、质感更“高级”
    // 柔和粉调色板（可改为你站点主色）
    const palette = [
      ['#ff7aa2', '#ffc2d1'],
      ['#ff9db5', '#ffd1dc'],
      ['#ff85a1', '#ffc8dd']
    ];

    for (let i = 0; i < count; i++) {
      const el = document.createElement('i');
      el.className = 'petal';
      const [c1, c2] = palette[i % palette.length];
      el.style.setProperty('--c1', c1);
      el.style.setProperty('--c2', c2);

      const angle = (i / count) * 2 * Math.PI + (Math.random() * 0.5 - 0.25);
      const radius = 80 + Math.random() * 40;             // 飞行半径
      const dx = Math.cos(angle) * radius;
      const dy = Math.sin(angle) * radius - 20;            // 略向上
      const rotStart = Math.random() * 180;
      const rot = Math.random() * 180 - 90;                // 轻微翻转
      const scale = (0.9 + Math.random() * 0.5).toFixed(2);
      const dur = 900 + Math.random() * 500;               // 0.9–1.4s

      el.style.setProperty('--x', `${cx}px`);
      el.style.setProperty('--y', `${cy}px`);
      el.style.setProperty('--dx', `${dx}px`);
      el.style.setProperty('--dy', `${dy}px`);
      el.style.setProperty('--rot-start', `${rotStart}deg`);
      el.style.setProperty('--rot', `${rot}deg`);
      el.style.setProperty('--scale', scale);
      el.style.setProperty('--dur', `${dur}ms`);

      layer.appendChild(el);
      el.addEventListener('animationend', () => el.remove());
    }
  }

  // ===== 读取当前计数（Class 不存在时当 0） =====
  async function getCount() {
    try {
      const q = new AV.Query('Flower');
      q.equalTo('slug', slug);
      const obj = await q.first();
      return obj ? (obj.get('count') || 0) : 0;
    } catch (e) {
      if (e && e.code === 101) return 0; // Class or object doesn't exist
      throw e;
    }
  }

  // ===== +1；记录不存在则先创建后自增 =====
  async function increment() {
    let obj = null;
    try {
      const q = new AV.Query('Flower');
      q.equalTo('slug', slug);
      obj = await q.first();
    } catch (e) {
      if (!(e && e.code === 101)) throw e;
    }
    if (!obj) {
      obj = new AV.Object('Flower');
      obj.set('slug', slug);
      obj.set('count', 0);
    }
    obj.increment('count', 1);
    await obj.save();
    return obj.get('count') || 0;
  }

  async function refresh() {
    try {
      $count.textContent = await getCount();
    } catch (e) {
      showError('读取', e);
    }
  }

  // ===== 点击送花 =====
  $btn.addEventListener('click', async () => {
    const dayKey = 'flower:' + slug + ':' + new Date().toISOString().slice(0, 10);
    if (localStorage.getItem(dayKey)) {
      toast(MSG_LIMITED);
      return;
    }

    $btn.disabled = true;
    try {
      const n = await increment();
      $count.textContent = n;

      // 小反馈动画
      $count.classList.add('bump');
      setTimeout(() => $count.classList.remove('bump'), 300);

      // 记下“今天已送过”
      localStorage.setItem(dayKey, '1');

      // 成功提示 + “撒花”
      if (ONLY_FIRST_EVER) {
        const everKey = 'flower-ever:' + slug;
        if (!localStorage.getItem(everKey)) {
          toast(MSG_SUCCESS);
          petalsBurst($btn);               // ← 高级感撒花
          localStorage.setItem(everKey, '1');
        }
      } else {
        toast(MSG_SUCCESS);
        petalsBurst($btn);                 // ← 每天第一次成功才撒花
      }
    } catch (e) {
      showError('送花', e);
    } finally {
      $btn.disabled = false;
    }
  });

  document.addEventListener('DOMContentLoaded', refresh);
</script>

<style>
  /* 居中排版 */
  .flower-box {
    display:flex; justify-content:center; align-items:center;
    gap:.5rem; margin:1.25rem auto; width:100%; text-align:center;
  }
  .flower-btn { border:0; padding:.45rem .8rem; border-radius:999px; cursor:pointer; font-size:14px; }
  .flower-btn:active { transform:scale(0.98); }
  .flower-count { font-variant-numeric: tabular-nums; }

  /* 数字轻微弹跳动画 */
  @keyframes bump { 0%{transform:scale(1)} 50%{transform:scale(1.18)} 100%{transform:scale(1)} }
  .flower-count.bump { animation: bump .28s ease; }

  /* Toast 提示 */
  .flower-toast{
    position:fixed; left:50%; bottom:10vh; transform:translateX(-50%);
    background:rgba(0,0,0,.78); color:#fff; padding:.6rem .9rem;
    border-radius:.75rem; font-size:14px; line-height:1.2;
    opacity:0; pointer-events:none; transition:opacity .22s, transform .22s;
    z-index:9999;
  }
  .flower-toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }

  /* ===== 高级感“撒花”样式 ===== */
  #petal-layer{
    position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:9998;
  }
  .petal{
    position:absolute;
    left:var(--x); top:var(--y);
    width:10px; height:14px;
    transform:translate(-50%,-50%) scale(var(--scale)) rotate(var(--rot-start,0deg));
    opacity:0; will-change:transform,opacity; filter:blur(.1px);
    border-radius:100% 100% 60% 60%; /* 花瓣轮廓 */
    background:
      radial-gradient(40% 40% at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,0) 70%),
      linear-gradient(180deg, var(--c1), var(--c2));
    animation: petal-fly var(--dur) cubic-bezier(.2,.8,.2,1) forwards;
  }
  @keyframes petal-fly{
    0%   { opacity:0; transform:translate(-50%,-50%) scale(calc(var(--scale)*.6)) rotate(var(--rot-start,0deg)); }
    10%  { opacity:1; }
    100% { opacity:0; transform:translate(calc(-50% + var(--dx)), calc(-50% + var(--dy)))
                         scale(var(--scale)) rotate(calc(var(--rot-start) + var(--rot))); }
  }
  @media (prefers-reduced-motion: reduce){
    .petal{ animation:none; opacity:0; }
  }
</style>
