<!-- ç»“æ„ä¸å˜ -->
<div class="flower-box">
  <button id="flower-btn" class="flower-btn" aria-label="é€èŠ±">ğŸŒ¸ é€èŠ±</button>
  <span id="flower-count" class="flower-count">0</span>
</div>

<!-- LeanCloud JS SDKï¼ˆå›ºå®šç‰ˆæœ¬ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av-min.js"></script>
<script>
  // ===== ä½ çš„ LeanCloud åˆå§‹åŒ–ï¼šä¿æŒä½ ç°åœ¨çš„é…ç½® =====
  AV.init({
    appId: 'GYcDHtwby7Z0jfTPS4sE5vSB-gzGzoHsz',
    appKey: 'XHcF55G1bbSGIRgvsBeJ1htf',
    serverURL: 'https://gycdhtwb.lc-cn-n1-shared.com'
    // è‹¥ä»¥åæƒ³æ›´ç¨³ï¼Œå¯ç»Ÿä¸€ç”¨ https://api.leancloud.app æˆ–ä½ ç»‘å®šçš„è‡ªå®šä¹‰ API åŸŸå
  });

  // ===== æ–‡æ¡ˆï¼ˆæŒ‰éœ€ä¿®æ”¹ï¼‰ =====
  const MSG_SUCCESS = 'ğŸŒ¸ æ”¶åˆ°ä½ çš„èŠ±å•¦ï¼Œè°¢è°¢ï¼æ„¿ä½ ä»Šå¤©ä¹Ÿå¼€å¿ƒã€‚';
  const MSG_LIMITED = 'ä»Šå¤©å·²ç»é€è¿‡å•¦ï¼Œæ˜å¤©å†æ¥ï½';

  // å¦‚æœä½ åªæƒ³â€œç»ˆèº«ç¬¬ä¸€æ¬¡â€æ‰å¼¹æç¤ºï¼ŒæŠŠä¸‹é¢å¼€å…³è®¾ä¸º true
  const ONLY_FIRST_EVER = false;

  // ===== åŸºæœ¬å˜é‡ =====
  const slug = '{{ page.path }}';   // ç”¨æ–‡ä»¶è·¯å¾„åš key æ›´ç¨³
  const $btn = document.getElementById('flower-btn');
  const $count = document.getElementById('flower-count');

  // ===== è½»é‡ toastï¼ˆéé˜»å¡ï¼‰ =====
  function toast(msg, ms = 1800) {
    let el = document.getElementById('flower-toast');
    if (!el) {
      el = document.createElement('div');
      el.id = 'flower-toast';
      el.className = 'flower-toast';
      document.body.appendChild(el);
    }
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(el._timer);
    el._timer = setTimeout(() => el.classList.remove('show'), ms);
  }

  function showError(where, e) {
    console.error(`[Flower] ${where} error:`, e);
    const msg = `${(e && e.code) || ''} ${(e && e.message) || e}`;
    toast(`é€èŠ±å¤±è´¥ï¼ˆ${where}ï¼‰ï¼š${msg}`);
  }

  // ===== è¯»å–å½“å‰è®¡æ•°ï¼ˆClass ä¸å­˜åœ¨æ—¶å½“ 0ï¼‰ =====
  async function getCount() {
    try {
      const q = new AV.Query('Flower');
      q.equalTo('slug', slug);
      const obj = await q.first();
      return obj ? (obj.get('count') || 0) : 0;
    } catch (e) {
      if (e && e.code === 101) return 0; // Class or object doesn't exist
      throw e;
    }
  }

  // ===== +1ï¼›è®°å½•ä¸å­˜åœ¨åˆ™å…ˆåˆ›å»ºåè‡ªå¢ =====
  async function increment() {
    let obj = null;
    try {
      const q = new AV.Query('Flower');
      q.equalTo('slug', slug);
      obj = await q.first();
    } catch (e) {
      if (!(e && e.code === 101)) throw e;
    }
    if (!obj) {
      obj = new AV.Object('Flower');
      obj.set('slug', slug);
      obj.set('count', 0);
    }
    obj.increment('count', 1);
    await obj.save();
    return obj.get('count') || 0;
  }

  async function refresh() {
    try {
      $count.textContent = await getCount();
    } catch (e) {
      showError('è¯»å–', e);
    }
  }

  // ===== ç‚¹å‡»é€èŠ± =====
  $btn.addEventListener('click', async () => {
    const dayKey = 'flower:' + slug + ':' + new Date().toISOString().slice(0,10);
    if (localStorage.getItem(dayKey)) {
      toast(MSG_LIMITED);
      return;
    }

    $btn.disabled = true;
    try {
      const n = await increment();
      $count.textContent = n;

      // å°åŠ¨ç”»è®©æ•°å­—æ›´â€œæœ‰åé¦ˆæ„Ÿâ€
      $count.classList.add('bump');
      setTimeout(() => $count.classList.remove('bump'), 300);

      // è®°ä¸‹â€œä»Šå¤©å·²é€è¿‡â€
      localStorage.setItem(dayKey, '1');

      // æˆåŠŸæç¤ºï¼ˆå½“å¤©ç¬¬ä¸€æ¬¡ï¼‰
      if (ONLY_FIRST_EVER) {
        const everKey = 'flower-ever:' + slug;
        if (!localStorage.getItem(everKey)) {
          toast(MSG_SUCCESS);
          localStorage.setItem(everKey, '1');
        }
      } else {
        // æ¯å¤©ç¬¬ä¸€æ¬¡æˆåŠŸå°±æç¤º
        toast(MSG_SUCCESS);
      }
    } catch (e) {
      showError('é€èŠ±', e);
    } finally {
      $btn.disabled = false;
    }
  });

  document.addEventListener('DOMContentLoaded', refresh);
</script>

<style>
  /* å±…ä¸­æ’ç‰ˆ */
  .flower-box {
    display:flex; justify-content:center; align-items:center;
    gap:.5rem; margin:1.25rem auto; width:100%; text-align:center;
  }
  .flower-btn { border:0; padding:.45rem .8rem; border-radius:999px; cursor:pointer; font-size:14px; }
  .flower-btn:active { transform:scale(0.98); }
  .flower-count { font-variant-numeric: tabular-nums; }

  /* æ•°å­—è½»å¾®å¼¹è·³åŠ¨ç”» */
  @keyframes bump { 0%{transform:scale(1)} 50%{transform:scale(1.18)} 100%{transform:scale(1)} }
  .flower-count.bump { animation: bump .28s ease; }

  /* Toast æç¤º */
  .flower-toast{
    position:fixed; left:50%; bottom:10vh; transform:translateX(-50%);
    background:rgba(0,0,0,.78); color:#fff; padding:.6rem .9rem;
    border-radius:.75rem; font-size:14px; line-height:1.2;
    opacity:0; pointer-events:none; transition:opacity .22s, transform .22s;
    z-index:9999;
  }
  .flower-toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }
</style>
