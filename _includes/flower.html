<!-- ç»“æ„ä¸å˜ -->
<div class="flower-box">
  <button id="flower-btn" class="flower-btn" aria-label="é€èŠ±">ğŸŒ¸ é€èŠ±</button>
  <span id="flower-count" class="flower-count">0</span>
</div>

<!-- LeanCloud JS SDKï¼ˆå›ºå®šç‰ˆæœ¬ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av-min.js"></script>
<script>
  // ===== ä½ çš„ LeanCloud åˆå§‹åŒ–ï¼šä¿æŒä½ ç°åœ¨çš„é…ç½® =====
  AV.init({
    appId: 'GYcDHtwby7Z0jfTPS4sE5vSB-gzGzoHsz',
    appKey: 'XHcF55G1bbSGIRgvsBeJ1htf',
    serverURL: 'https://gycdhtwb.lc-cn-n1-shared.com'
  });

  // ===== æ–‡æ¡ˆï¼ˆæŒ‰éœ€ä¿®æ”¹ï¼‰ =====
  const MSG_SUCCESS = 'ğŸŒ¸ æ”¶åˆ°ä½ çš„èŠ±å•¦ï¼Œè°¢è°¢ï¼æ„¿ä½ ä»Šå¤©ä¹Ÿå¼€å¿ƒã€‚';
  const MSG_LIMITED = 'ä»Šå¤©å·²ç»é€è¿‡å•¦ï¼Œæ˜å¤©å†æ¥ï½';
  // ä»…â€œç”Ÿå¹³ç¬¬ä¸€æ¬¡â€æ‰æç¤ºï¼štrueï¼›é»˜è®¤ï¼šæ¯å¤©ç¬¬ä¸€æ¬¡
  const ONLY_FIRST_EVER = false;

  // ===== åŸºæœ¬å˜é‡ =====
  const slug = '{{ page.path }}';            // ç”¨æ–‡ä»¶è·¯å¾„åš key æ›´ç¨³
  const $btn = document.getElementById('flower-btn');
  const $count = document.getElementById('flower-count');

  // ===== è½»é‡ toastï¼ˆéé˜»å¡ï¼‰ =====
  function toast(msg, ms = 1800) {
    let el = document.getElementById('flower-toast');
    if (!el) {
      el = document.createElement('div');
      el.id = 'flower-toast';
      el.className = 'flower-toast';
      document.body.appendChild(el);
    }
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(el._timer);
    el._timer = setTimeout(() => el.classList.remove('show'), ms);
  }

  function showError(where, e) {
    console.error(`[Flower] ${where} error:`, e);
    const msg = `${(e && e.code) || ''} ${(e && e.message) || e}`;
    toast(`é€èŠ±å¤±è´¥ï¼ˆ${where}ï¼‰ï¼š${msg}`);
  }

  // ===== æç®€â€œæ’’èŠ±â€æ•ˆæœï¼ˆé«˜é›…ã€è½»é‡ã€å°Šé‡å‡å°‘åŠ¨ç”»ï¼‰ =====
  function ensurePetalLayer() {
    let layer = document.getElementById('petal-layer');
    if (!layer) {
      layer = document.createElement('div');
      layer.id = 'petal-layer';
      document.body.appendChild(layer);
    }
    return layer;
  }

  function petalsBurst(anchorEl) {
    // ç³»ç»Ÿè®¾ä¸ºâ€œå‡å°‘åŠ¨ç”»â€æ—¶ç›´æ¥è·³è¿‡
    if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

    const layer = ensurePetalLayer();
    const rect = anchorEl.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + rect.height / 2;

    const count = 14; // æ•°é‡å°‘ã€è´¨æ„Ÿæ›´â€œé«˜çº§â€
    // æŸ”å’Œç²‰è°ƒè‰²æ¿ï¼ˆå¯æ”¹ä¸ºä½ ç«™ç‚¹ä¸»è‰²ï¼‰
    const palette = [
      ['#ff7aa2', '#ffc2d1'],
      ['#ff9db5', '#ffd1dc'],
      ['#ff85a1', '#ffc8dd']
    ];

    for (let i = 0; i < count; i++) {
      const el = document.createElement('i');
      el.className = 'petal';
      const [c1, c2] = palette[i % palette.length];
      el.style.setProperty('--c1', c1);
      el.style.setProperty('--c2', c2);

      const angle = (i / count) * 2 * Math.PI + (Math.random() * 0.5 - 0.25);
      const radius = 80 + Math.random() * 40;             // é£è¡ŒåŠå¾„
      const dx = Math.cos(angle) * radius;
      const dy = Math.sin(angle) * radius - 20;            // ç•¥å‘ä¸Š
      const rotStart = Math.random() * 180;
      const rot = Math.random() * 180 - 90;                // è½»å¾®ç¿»è½¬
      const scale = (0.9 + Math.random() * 0.5).toFixed(2);
      const dur = 900 + Math.random() * 500;               // 0.9â€“1.4s

      el.style.setProperty('--x', `${cx}px`);
      el.style.setProperty('--y', `${cy}px`);
      el.style.setProperty('--dx', `${dx}px`);
      el.style.setProperty('--dy', `${dy}px`);
      el.style.setProperty('--rot-start', `${rotStart}deg`);
      el.style.setProperty('--rot', `${rot}deg`);
      el.style.setProperty('--scale', scale);
      el.style.setProperty('--dur', `${dur}ms`);

      layer.appendChild(el);
      el.addEventListener('animationend', () => el.remove());
    }
  }

  // ===== è¯»å–å½“å‰è®¡æ•°ï¼ˆClass ä¸å­˜åœ¨æ—¶å½“ 0ï¼‰ =====
  async function getCount() {
    try {
      const q = new AV.Query('Flower');
      q.equalTo('slug', slug);
      const obj = await q.first();
      return obj ? (obj.get('count') || 0) : 0;
    } catch (e) {
      if (e && e.code === 101) return 0; // Class or object doesn't exist
      throw e;
    }
  }

  // ===== +1ï¼›è®°å½•ä¸å­˜åœ¨åˆ™å…ˆåˆ›å»ºåè‡ªå¢ =====
  async function increment() {
    let obj = null;
    try {
      const q = new AV.Query('Flower');
      q.equalTo('slug', slug);
      obj = await q.first();
    } catch (e) {
      if (!(e && e.code === 101)) throw e;
    }
    if (!obj) {
      obj = new AV.Object('Flower');
      obj.set('slug', slug);
      obj.set('count', 0);
    }
    obj.increment('count', 1);
    await obj.save();
    return obj.get('count') || 0;
  }

  async function refresh() {
    try {
      $count.textContent = await getCount();
    } catch (e) {
      showError('è¯»å–', e);
    }
  }

  // ===== ç‚¹å‡»é€èŠ± =====
  $btn.addEventListener('click', async () => {
    const dayKey = 'flower:' + slug + ':' + new Date().toISOString().slice(0, 10);
    if (localStorage.getItem(dayKey)) {
      toast(MSG_LIMITED);
      return;
    }

    $btn.disabled = true;
    try {
      const n = await increment();
      $count.textContent = n;

      // å°åé¦ˆåŠ¨ç”»
      $count.classList.add('bump');
      setTimeout(() => $count.classList.remove('bump'), 300);

      // è®°ä¸‹â€œä»Šå¤©å·²é€è¿‡â€
      localStorage.setItem(dayKey, '1');

      // æˆåŠŸæç¤º + â€œæ’’èŠ±â€
      if (ONLY_FIRST_EVER) {
        const everKey = 'flower-ever:' + slug;
        if (!localStorage.getItem(everKey)) {
          toast(MSG_SUCCESS);
          petalsBurst($btn);               // â† é«˜çº§æ„Ÿæ’’èŠ±
          localStorage.setItem(everKey, '1');
        }
      } else {
        toast(MSG_SUCCESS);
        petalsBurst($btn);                 // â† æ¯å¤©ç¬¬ä¸€æ¬¡æˆåŠŸæ‰æ’’èŠ±
      }
    } catch (e) {
      showError('é€èŠ±', e);
    } finally {
      $btn.disabled = false;
    }
  });

  document.addEventListener('DOMContentLoaded', refresh);
</script>

<style>
  /* å±…ä¸­æ’ç‰ˆ */
  .flower-box {
    display:flex; justify-content:center; align-items:center;
    gap:.5rem; margin:1.25rem auto; width:100%; text-align:center;
  }
  .flower-btn { border:0; padding:.45rem .8rem; border-radius:999px; cursor:pointer; font-size:14px; }
  .flower-btn:active { transform:scale(0.98); }
  .flower-count { font-variant-numeric: tabular-nums; }

  /* æ•°å­—è½»å¾®å¼¹è·³åŠ¨ç”» */
  @keyframes bump { 0%{transform:scale(1)} 50%{transform:scale(1.18)} 100%{transform:scale(1)} }
  .flower-count.bump { animation: bump .28s ease; }

  /* Toast æç¤º */
  .flower-toast{
    position:fixed; left:50%; bottom:10vh; transform:translateX(-50%);
    background:rgba(0,0,0,.78); color:#fff; padding:.6rem .9rem;
    border-radius:.75rem; font-size:14px; line-height:1.2;
    opacity:0; pointer-events:none; transition:opacity .22s, transform .22s;
    z-index:9999;
  }
  .flower-toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }

  /* ===== é«˜çº§æ„Ÿâ€œæ’’èŠ±â€æ ·å¼ ===== */
  #petal-layer{
    position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:9998;
  }
  .petal{
    position:absolute;
    left:var(--x); top:var(--y);
    width:10px; height:14px;
    transform:translate(-50%,-50%) scale(var(--scale)) rotate(var(--rot-start,0deg));
    opacity:0; will-change:transform,opacity; filter:blur(.1px);
    border-radius:100% 100% 60% 60%; /* èŠ±ç“£è½®å»“ */
    background:
      radial-gradient(40% 40% at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,0) 70%),
      linear-gradient(180deg, var(--c1), var(--c2));
    animation: petal-fly var(--dur) cubic-bezier(.2,.8,.2,1) forwards;
  }
  @keyframes petal-fly{
    0%   { opacity:0; transform:translate(-50%,-50%) scale(calc(var(--scale)*.6)) rotate(var(--rot-start,0deg)); }
    10%  { opacity:1; }
    100% { opacity:0; transform:translate(calc(-50% + var(--dx)), calc(-50% + var(--dy)))
                         scale(var(--scale)) rotate(calc(var(--rot-start) + var(--rot))); }
  }
  @media (prefers-reduced-motion: reduce){
    .petal{ animation:none; opacity:0; }
  }
</style>
