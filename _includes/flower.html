<div class="flower-box">
  <button id="flower-btn" class="flower-btn" aria-label="é€èŠ±">ğŸŒ¸ é€èŠ±</button>
  <span id="flower-count" class="flower-count">0</span>
</div>

<!-- LeanCloud JS SDKï¼ˆå›ºå®šç‰ˆæœ¬ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av-min.js"></script>
<script>
  AV.init({
    appId: '0K9GjJzIqyb6Q2bzmbnLfjMN-MdYXbMMI',
    appKey: 'Swt0oJDjVR5ffS93m1bZENQN',
    serverURL: 'https://0k9gjjzi.api.lncldglobal.com' // æ§åˆ¶å°æ˜¾ç¤ºçš„ API åŸŸåï¼Œå¦‚ https://api.leancloud.app æˆ–ä½ çš„ä¸“å±åŸŸå
  });

  // ç”¨æ–‡ä»¶ç›¸å¯¹è·¯å¾„æ›´ç¨³ï¼ˆæ”¹ permalink æ—¶ä¹Ÿä¸ä¸¢æ•°æ®ï¼›è‹¥ä½ æ›´æƒ³ç”¨ URLï¼Œå¯æ”¹æˆ {{ page.url }}ï¼‰
  const slug = '{{ page.path }}';

  const $btn = document.getElementById('flower-btn');
  const $count = document.getElementById('flower-count');

  function errAlert(where, e) {
    console.error(`[Flower] ${where} error:`, e);
    alert(`é€èŠ±å¤±è´¥ï¼ˆ${where}ï¼‰ï¼š${(e && e.code) || ''} ${(e && e.message) || e}`);
  }

  // è¯»å–å½“å‰è®¡æ•°ï¼šClass ä¸å­˜åœ¨æ—¶å½“ 0
  async function getCount() {
    try {
      const q = new AV.Query('Flower');
      q.equalTo('slug', slug);
      const obj = await q.first();
      return obj ? (obj.get('count') || 0) : 0;
    } catch (e) {
      if (e && e.code === 101) return 0;  // Class or object doesn't exist
      throw e;
    }
  }

  // +1ï¼šå¦‚æœè®°å½•ä¸å­˜åœ¨åˆ™å…ˆåˆ›å»ºåè‡ªå¢
  async function increment() {
    let obj = null;
    try {
      const q = new AV.Query('Flower');
      q.equalTo('slug', slug);
      obj = await q.first();
    } catch (e) {
      if (!(e && e.code === 101)) throw e;  // é 101 é”™è¯¯æ‰æŠ›
    }

    if (!obj) {
      // é¦–æ¬¡åˆ›å»ºï¼ˆClass ä¹Ÿä¼šåœ¨é¦–æ¬¡ä¿å­˜æ—¶è‡ªåŠ¨åˆ›å»ºï¼‰
      obj = new AV.Object('Flower');
      obj.set('slug', slug);
      obj.set('count', 0);
    }
    obj.increment('count', 1);
    await obj.save();
    return obj.get('count') || 0;
  }

  async function refresh() {
    try { $count.textContent = await getCount(); }
    catch (e) { errAlert('è¯»å–', e); }
  }

  $btn.addEventListener('click', async () => {
    const key = 'flower:' + slug + ':' + new Date().toISOString().slice(0,10);
    if (localStorage.getItem(key)) { alert('ä»Šå¤©å·²ç»é€è¿‡å•¦ï¼Œæ˜å¤©å†æ¥ï½'); return; }
    $btn.disabled = true;
    try {
      const n = await increment();
      $count.textContent = n;
      localStorage.setItem(key, '1');
    } catch (e) {
      errAlert('é€èŠ±', e);
    } finally {
      $btn.disabled = false;
    }
  });

  document.addEventListener('DOMContentLoaded', refresh);
</script>

<style>
  .flower-box {
    display:flex; justify-content:center; align-items:center;
    gap:.5rem; margin:1.25rem auto; width:100%; text-align:center;
  }
  .flower-btn { border:0; padding:.45rem .8rem; border-radius:999px; cursor:pointer; font-size:14px; }
  .flower-btn:active { transform:scale(0.98); }
  .flower-count { font-variant-numeric: tabular-nums; }
</style>