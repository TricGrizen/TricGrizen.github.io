<div class="flower-box">
  <button id="flower-btn" class="flower-btn" aria-label="é€èŠ±">ğŸŒ¸ é€èŠ±</button>
  <span id="flower-count" class="flower-count">0</span>
</div>

<!-- LeanCloud JS SDKï¼ˆå›ºå®šç‰ˆæœ¬ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av-min.js"></script>
<script>
  // 1) åˆå§‹åŒ–ï¼ˆåˆ‡å‹¿æŠŠ Master Key æ”¾å‰ç«¯ï¼‰
  AV.init({
    appId: '0K9GjJzIqyb6Q2bzmbnLfjMN-MdYXbMMI',
    appKey: 'Swt0oJDjVR5ffS93m1bZENQN',
    serverURL: 'https://0k9gjjzi.api.lncldglobal.com' // ä¾‹å¦‚ï¼šhttps://api.leancloud.app
  });

  // 2) ç”¨å½“å‰æ–‡ç« çš„ URL ä½œä¸ºå”¯ä¸€é”®ï¼ˆJekyll ä¼šåœ¨æ„å»ºæ—¶æŠŠå˜é‡æ›¿æ¢æˆçœŸå®è·¯å¾„ï¼‰
  const slug = '{{ page.url }}';

  // 3) é¦–æ¬¡åŠ è½½ï¼šè¯»å–è®¡æ•°
  async function refresh() {
    const query = new AV.Query('Flower');
    query.equalTo('slug', slug);
    const obj = await query.first();
    document.getElementById('flower-count').textContent = obj ? (obj.get('count') || 0) : 0;
  }

  // 4) ç‚¹å‡»é€èŠ±ï¼šä½¿ç”¨ LeanCloud çš„åŸå­è‡ªå¢ï¼ˆé¿å…å¹¶å‘è¦†ç›–ï¼‰
  document.getElementById('flower-btn').addEventListener('click', async () => {
    const btn = document.getElementById('flower-btn');
    const key = 'flower:' + slug + ':' + new Date().toISOString().slice(0,10);
    if (localStorage.getItem(key)) { alert('è°¢è°¢ä½ çš„èŠ±èŠ±~'); return; }
    btn.disabled = true;
    try {
      const query = new AV.Query('Flower');
      query.equalTo('slug', slug);
      let obj = await query.first();
      if (!obj) { const Flower = AV.Object.extend('Flower'); obj = new Flower(); obj.set('slug', slug); obj.set('count', 0); }
      obj.increment('count', 1);
      await obj.save();
      document.getElementById('flower-count').textContent = obj.get('count') || 0;
      localStorage.setItem(key, '1');
    } catch (e) {
      console.error(e); alert('ç½‘ç»œå¼‚å¸¸ï¼Œç¨åå†è¯•');
    } finally {
      btn.disabled = false;
    }
  });

  document.addEventListener('DOMContentLoaded', refresh);
</script>

<style>
  .flower-box { display:inline-flex; align-items:center; gap:.5rem; margin-top:1rem; }
  .flower-btn { border:0; padding:.45rem .8rem; border-radius:999px; cursor:pointer; font-size:14px; }
  .flower-btn:active { transform: scale(0.98); }
  .flower-count { font-variant-numeric: tabular-nums; }
</style>
